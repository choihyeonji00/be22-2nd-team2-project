<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>Next Page - ì†Œì„¤ ìƒì„¸</title>
    <style>
        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin-right: 2px;
            animation: typing-blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes typing-blink {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
    </style>
</head>

<body>

    <div layout:fragment="content">
        <div id="book-header" class="text-center mb-4 fade-in">
            <!-- JS injected -->
            <h1 id="book-title" style="margin-bottom: 10px;">Loading...</h1>
            <p id="book-info" style="color: var(--text-muted);"></p>
            <div style="margin-top: 15px;">
                <button class="btn btn-outline" id="upvote-book-btn">ğŸ‘ ê°œì¶” <span
                        id="book-upvote-count">0</span></button>
                <button class="btn btn-outline" id="downvote-book-btn" style="margin-left: 5px;">ğŸ‘ ë¹„ì¶” <span
                        id="book-downvote-count">0</span></button>
                <a href="#" id="view-mode-btn" class="btn btn-primary" style="margin-left: 10px;">ğŸ“– ì±…ìœ¼ë¡œ ì½ê¸°</a>
            </div>
        </div>

        <div class="container" style="max-width: 800px;">
            <!-- Sentence List -->
            <div id="sentence-list" style="margin-bottom: 40px;">
                <!-- JS populated -->
            </div>

            <!-- Writing Area -->
            <div id="writing-area" class="card fade-in" style="padding: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">ë‹¤ìŒ ë¬¸ì¥ ì´ì–´ì“°ê¸°</h3>
                    <!-- Typing Indicator (Minimal) -->
                    <div id="typing-indicator"
                        style="display: none; font-size: 0.8rem; color: var(--primary-color); align-items: center; gap: 4px;">
                        <span style="display: flex; gap: 2px;">
                            <span class="typing-dot" style="animation-delay: 0s;"></span>
                            <span class="typing-dot" style="animation-delay: 0.2s;"></span>
                            <span class="typing-dot" style="animation-delay: 0.4s;"></span>
                        </span>
                        <span id="typing-user" style="font-weight: 600; margin-left: 4px;"></span>ë‹˜ì´ ì…ë ¥ ì¤‘...
                    </div>
                </div>

                <!-- Guest Only: Slim Premium Design -->
                <div class="guest-only"
                    style="display: none; text-align: center; padding: 25px 15px; background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px dashed rgba(0,0,0,0.1);">
                    <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem;">
                        ì´ì•¼ê¸°ì— ì°¸ì—¬í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                    <button onclick="openModal('login-modal')" class="btn btn-primary"
                        style="padding: 8px 20px; font-size: 0.85rem; border-radius: 20px;">
                        ë¡œê·¸ì¸í•˜ê³  ì´ì–´ì“°ê¸°
                    </button>
                </div>

                <!-- User Only: Compact Form -->
                <div class="user-only" style="display: none;">
                    <textarea id="sentence-input" class="form-control" rows="2"
                        placeholder="ë‹¹ì‹ ì˜ ìƒìƒë ¥ì„ í¼ì³ë³´ì„¸ìš”... (ìµœëŒ€ 200ì)"
                        style="border-radius: 10px; font-size: 0.95rem; resize: none;"></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="submitSentence()"
                            style="padding: 8px 25px; font-size: 0.9rem; border-radius: 20px;">ë¬¸ì¥ ë“±ë¡</button>
                    </div>
                </div>
            </div>

            <!-- Comments Area -->
            <div class="card fade-in" style="margin-top: 40px; padding: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">ê°ìƒí‰</h3>
                    <!-- Comment Typing Indicator -->
                    <div id="comment-typing-indicator"
                        style="display: none; font-size: 0.75rem; color: var(--secondary-color);">
                        ğŸ’¬ <span id="comment-typing-user" style="font-weight: 600;"></span>ë‹˜ì´ ì‘ì„± ì¤‘...
                    </div>
                </div>

                <!-- Guest Only: Slim Design -->
                <div class="guest-only"
                    style="display: none; text-align: center; padding: 20px; background: rgba(0,0,0,0.02); border-radius: 12px; margin-bottom: 20px;">
                    <button onclick="openModal('login-modal')" class="btn btn-outline"
                        style="padding: 6px 20px; font-size: 0.8rem; border-radius: 20px;">
                        ë¡œê·¸ì¸í•˜ê³  ê°ìƒí‰ ë‚¨ê¸°ê¸°
                    </button>
                </div>

                <!-- User Only: Slim Form -->
                <div class="user-only" style="display: none;">
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <input type="text" id="comment-input" class="form-control" placeholder="ê°ìƒí‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."
                            style="border-radius: 20px; font-size: 0.9rem; padding: 8px 15px;">
                        <button class="btn btn-primary" onclick="submitComment()"
                            style="padding: 0 20px; font-size: 0.85rem; border-radius: 20px; white-space: nowrap;">ë“±ë¡</button>
                    </div>
                </div>

                <div id="comment-list">
                    <!-- Comments populated here -->
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script>
            // URLì—ì„œ bookId ì¶”ì¶œ (ë” ì•ˆì „í•œ ë°©ì‹)
            const pathParts = window.location.pathname.split('/');
            const bookId = pathParts.includes('books') ? pathParts[pathParts.indexOf('books') + 1] : pathParts.pop();

            let stompClient = null;
            let currentUserNickname = null;
            let typingTimeout = null;

            $(document).ready(function () {
                loadBookDetail();
                loadComments();
                connectWebSocket();
            });

            // WebSocket ì—°ê²°
            function connectWebSocket() {
                // ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ WebSocket ì—°ê²° (íƒ€ì´í•‘ ìƒíƒœ ë³´ê¸° ìœ„í•´)
                const token = localStorage.getItem('accessToken');

                // WebSocket ì—°ê²° ì‹œì‘
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                stompClient.connect({}, function (frame) {

                    // íƒ€ì´í•‘ ìƒíƒœ êµ¬ë… (ë¬¸ì¥ ì‘ì„±) - ëª¨ë“  ì‚¬ìš©ìê°€ êµ¬ë…
                    stompClient.subscribe('/topic/typing', function (message) {
                        const status = JSON.parse(message.body);
                        handleTypingStatus(status);
                    });

                    // ëŒ“ê¸€ íƒ€ì´í•‘ ìƒíƒœ êµ¬ë… - ëª¨ë“  ì‚¬ìš©ìê°€ êµ¬ë…
                    stompClient.subscribe('/topic/comment-typing', function (message) {
                        const status = JSON.parse(message.body);
                        handleCommentTypingStatus(status);
                    });

                    // ìƒˆ ë¬¸ì¥ ì‹¤ì‹œê°„ êµ¬ë…
                    stompClient.subscribe('/topic/sentences/' + bookId, function (message) {
                        const sentenceEvent = JSON.parse(message.body);
                        handleNewSentence(sentenceEvent);
                    });
                }, function (error) {
                });

                // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                if (token) {
                    $.ajax({
                        url: '/api/members/me',
                        method: 'GET',
                        success: function (response) {
                            currentUserNickname = response.data.userNicknm;

                            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                            setupTypingEventListeners();
                        }
                    });
                }
            }

            // íƒ€ì´í•‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ)
            function setupTypingEventListeners() {

                // ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                $('#sentence-input').on('input', function () {
                    if (!stompClient || !currentUserNickname) return;

                    const payload = {
                        bookId: parseInt(bookId),
                        userNickname: currentUserNickname,
                        isTyping: true
                    };

                    // íƒ€ì´í•‘ ì‹œì‘ ì•Œë¦¼
                    stompClient.send("/app/typing/start", {}, JSON.stringify(payload));

                    // 3ì´ˆ ë™ì•ˆ ì¶”ê°€ ì…ë ¥ì´ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ì¢…ë£Œ
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(function () {
                        if (stompClient) {
                            const stopPayload = {
                                bookId: parseInt(bookId),
                                userNickname: currentUserNickname,
                                isTyping: false
                            };
                            stompClient.send("/app/typing/stop", {}, JSON.stringify(stopPayload));
                        }
                    }, 3000);
                });

                // ì…ë ¥ í•„ë“œê°€ í¬ì»¤ìŠ¤ë¥¼ ìƒìœ¼ë©´ íƒ€ì´í•‘ ì¢…ë£Œ
                $('#sentence-input').on('blur', function () {
                    if (!stompClient || !currentUserNickname) return;

                    clearTimeout(typingTimeout);
                    stompClient.send("/app/typing/stop", {}, JSON.stringify({
                        bookId: parseInt(bookId),
                        userNickname: currentUserNickname,
                        isTyping: false
                    }));
                });

                // ëŒ“ê¸€ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                let commentTypingTimeout = null;
                $('#comment-input').on('input', function () {
                    if (!stompClient || !currentUserNickname) return;

                    // ëŒ“ê¸€ íƒ€ì´í•‘ ì‹œì‘ ì•Œë¦¼
                    stompClient.send("/app/comment-typing/start", {}, JSON.stringify({
                        bookId: parseInt(bookId),
                        userNickname: currentUserNickname,
                        isTyping: true
                    }));

                    // 3ì´ˆ ë™ì•ˆ ì¶”ê°€ ì…ë ¥ì´ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ì¢…ë£Œ
                    clearTimeout(commentTypingTimeout);
                    commentTypingTimeout = setTimeout(function () {
                        if (stompClient) {
                            stompClient.send("/app/comment-typing/stop", {}, JSON.stringify({
                                bookId: parseInt(bookId),
                                userNickname: currentUserNickname,
                                isTyping: false
                            }));
                        }
                    }, 3000);
                });

                // ëŒ“ê¸€ ì…ë ¥ í•„ë“œê°€ í¬ì»¤ìŠ¤ë¥¼ ìƒìœ¼ë©´ íƒ€ì´í•‘ ì¢…ë£Œ
                $('#comment-input').on('blur', function () {
                    if (!stompClient || !currentUserNickname) return;

                    clearTimeout(commentTypingTimeout);
                    stompClient.send("/app/comment-typing/stop", {}, JSON.stringify({
                        bookId: parseInt(bookId),
                        userNickname: currentUserNickname,
                        isTyping: false
                    }));
                });
            }

            // íƒ€ì´í•‘ ìƒíƒœ ì²˜ë¦¬
            function handleTypingStatus(status) {
                // status.typing ë˜ëŠ” status.isTyping ë‘˜ ë‹¤ ëŒ€ì‘
                const isTyping = status.typing !== undefined ? status.typing : status.isTyping;

                if (status.bookId !== parseInt(bookId)) return;
                if (status.userNickname === currentUserNickname) return;

                const $indicator = $('#typing-indicator');
                const $input = $('#sentence-input');
                const $button = $('#writing-area .user-only button');

                if (isTyping) {
                    $('#typing-user').text(status.userNickname);
                    $indicator.fadeIn(200);
                    $input.prop('disabled', true).css('opacity', '0.6');
                    $button.prop('disabled', true).css('opacity', '0.6');
                } else {
                    $indicator.fadeOut(200);
                    $input.prop('disabled', false).css('opacity', '1');
                    $button.prop('disabled', false).css('opacity', '1');
                }
            }

            // ëŒ“ê¸€ íƒ€ì´í•‘ ìƒíƒœ ì²˜ë¦¬
            function handleCommentTypingStatus(status) {
                const isTyping = status.typing !== undefined ? status.typing : status.isTyping;

                if (status.bookId !== parseInt(bookId)) return;
                if (status.userNickname === currentUserNickname) return;

                const $indicator = $('#comment-typing-indicator');

                if (isTyping) {
                    $('#comment-typing-user').text(status.userNickname);
                    $indicator.fadeIn(200);
                } else {
                    $indicator.fadeOut(200);
                }
            }

            // ìƒˆ ë¬¸ì¥ ì‹¤ì‹œê°„ ì¶”ê°€
            function handleNewSentence(event) {
                const html = `
                    <div class="card new-sentence" style="padding: 15px; margin-bottom: 15px; border-left: 3px solid var(--primary-color); animation: slideInFromBottom 0.5s ease-out;">
                        <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 10px;">${event.content}</p>
                        <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between;">
                            <span>No.${event.sequenceNo} by ${event.writerNickname}</span>
                            <span>â¤ï¸ 0</span>
                        </div>
                    </div>
                `;

                const $newSentence = $(html);
                $('#sentence-list').append($newSentence);

                // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                $('html, body').animate({
                    scrollTop: $newSentence.offset().top - 100
                }, 500);
            }

            function loadBookDetail() {
                $.ajax({
                    url: '/api/books/' + bookId + '/view', // Using view mode API to get all sentences
                    method: 'GET',
                    success: function (response) {
                        const book = response.data;
                        const info = book.info || book;

                        $('#book-title').text(info.title || book.title);

                        // Fix categoryName - it might be categoryId or need to be fetched from categoryMap
                        const categoryDisplay = info.categoryName || window.categoryMap?.[info.categoryId] || info.categoryId || 'ë¯¸ë¶„ë¥˜';
                        const statusDisplay = info.status || book.status || 'WRITING';
                        const participantCount = info.participantCount || book.participantCount || 1;

                        $('#book-info').html(`<span>${categoryDisplay}</span> | <span>${statusDisplay}</span> | ì‘ê°€ ${participantCount}ëª…`);
                        $('#view-mode-btn').attr('href', '/books/' + bookId + '/viewer');

                        // Update Book Vote Counts
                        $('#book-upvote-count').text(book.likeCount || 0);
                        $('#book-downvote-count').text(book.dislikeCount || 0);

                        const $list = $('#sentence-list');
                        $list.empty();

                        // Assuming data.sentences is the list
                        const sentences = book.sentences || info.sentences || [];
                        sentences.forEach(sent => {
                            const html = `
                        <div class="card" style="padding: 15px; margin-bottom: 15px; border-left: 3px solid var(--primary-color);">
                            <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 10px;">${sent.content}</p>
                            <div style="font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between;">
                                <span>No.${sent.sequenceNo} by ${sent.writerNicknm}</span>
                                <div>
                                    <span style="margin-right: 8px;">ğŸ‘ ${sent.likeCount || 0}</span>
                                    <span>ğŸ‘ ${sent.dislikeCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                            $list.append(html);
                        });

                        if (statusDisplay === 'COMPLETED') {
                            $('#writing-area').hide();
                            $('#book-info').append(' <span class="badge badge-completed">ì™„ê²°ë¨</span>');
                        }
                    },
                    error: function (xhr) {
                        showToast('ì†Œì„¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    }
                });
            }

            function submitSentence() {
                const content = $('#sentence-input').val();
                if (!content) {
                    showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                $.ajax({
                    url: '/api/books/' + bookId + '/sentences',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ content: content }),
                    success: function () {
                        showToast('ë¬¸ì¥ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        $('#sentence-input').val('');
                        loadBookDetail(); // Reload to see new sentence
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) return;
                        showToast('ë“±ë¡ ì‹¤íŒ¨: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'), 'error');
                    }
                });
            }

            function loadComments() {
                $.ajax({
                    url: '/api/reactions/comments/' + bookId,
                    method: 'GET',
                    success: function (response) {
                        const comments = response.data; // Tree structure
                        $('#comment-list').empty();
                        renderComments(comments, $('#comment-list'));
                    }
                });
            }

            function renderComments(comments, $container) {
                if (!comments || comments.length === 0) return;

                comments.forEach(comment => {
                    const $node = $(`
                <div class="comment-node" id="comment-${comment.commentId}">
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: 600; font-size: 0.9rem; color: var(--primary-color);">${comment.writerNicknm}</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 10px;">${new Date(comment.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <button class="btn-reply" onclick="toggleReplyForm(${comment.commentId})">ë‹µê¸€ ë‹¬ê¸°</button>
                    </div>
                    <!-- Reply Form (Hidden) -->
                    <div id="reply-form-${comment.commentId}" style="display: none; margin-top: 10px; gap: 10px;">
                        <input type="text" class="form-control" style="font-size: 0.9rem;" placeholder="ë‹µê¸€ ì…ë ¥...">
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="submitReply(${comment.commentId})">ë“±ë¡</button>
                    </div>
                    <!-- Children Container -->
                    <div class="comment-children"></div>
                </div>
            `);

                    $container.append($node);

                    // Recursive render for children
                    if (comment.children && comment.children.length > 0) {
                        renderComments(comment.children, $node.find('.comment-children'));
                    }
                });
            }

            function toggleReplyForm(commentId) {
                const $form = $(`#reply-form-${commentId}`);
                if ($form.css('display') === 'none') {
                    $form.css('display', 'flex');
                } else {
                    $form.hide();
                }
            }

            function submitComment() {
                const content = $('#comment-input').val();
                if (!content) return;

                postComment(content, null);
            }

            function submitReply(parentId) {
                const $input = $(`#reply-form-${parentId} input`);
                const content = $input.val();
                if (!content) return;

                postComment(content, parentId);
            }

            function postComment(content, parentId) {
                // í† í° ì²´í¬
                if (!localStorage.getItem('accessToken')) {
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    openModal('login-modal');
                    return;
                }

                const data = {
                    bookId: bookId,
                    content: content,
                    parentId: parentId
                };

                $.ajax({
                    url: '/api/reactions/comments',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        if (parentId) {
                            toggleReplyForm(parentId);
                        } else {
                            $('#comment-input').val('');
                        }
                        loadComments();
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) return;
                        showToast('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'), 'error');
                    }
                });
            }
        </script>
    </th:block>

</body>

</html>