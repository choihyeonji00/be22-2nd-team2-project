<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}">

<head>
    <title>Next Page - í™ˆ</title>
</head>

<body>

    <div layout:fragment="content">
        <!-- Floating Atmosphere (Only on index page) -->
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>

        <div class="text-center mb-4" style="padding: 60px 0;">
            <h1 class="hero-title floating text-glow">
                ìš°ë¦¬ê°€ í•¨ê»˜ ë§Œë“œëŠ” ì´ì•¼ê¸°
            </h1>
            <p style="font-size: 1.2rem; color: var(--text-muted); max-width: 600px; margin: 0 auto; line-height: 1.8;">
                ë‹¹ì‹ ì˜ í•œ ë¬¸ì¥ì´ ë² ìŠ¤íŠ¸ì…€ëŸ¬ì˜ ì‹œì‘ì´ ë©ë‹ˆë‹¤.<br>
                ì§€ê¸ˆ ë°”ë¡œ ë¦´ë ˆì´ ì†Œì„¤ì— ì°¸ì—¬í•´ë³´ì„¸ìš”.
            </p>
            <div class="mt-4" id="hero-cta">
                <div class="guest-only" style="display: flex; justify-content: center; gap: 15px;">
                    <button onclick="openModal('login-modal')" class="btn btn-outline"
                        style="font-size: 1.1rem; padding: 12px 30px;">ë¡œê·¸ì¸</button>
                    <button onclick="openModal('signup-modal')" class="btn btn-primary"
                        style="font-size: 1.1rem; padding: 12px 30px;">íšŒì›ê°€ì…</button>
                </div>
                <div class="user-only" style="display: none; justify-content: center;">
                    <a href="/books/new" class="btn btn-primary" style="font-size: 1.1rem; padding: 12px 30px;">ì´ì•¼ê¸°
                        ì‹œì‘í•˜ê¸°</a>
                </div>
            </div>
        </div>

        <!-- Filter & Search -->
        <div class="card"
            style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; z-index: 10; position: relative; margin-bottom: 30px;">
            <select class="form-control" style="width: auto;" id="category-filter">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="ROMANCE">ë¡œë§¨ìŠ¤</option>
                <option value="THRILLER">ìŠ¤ë¦´ëŸ¬</option>
                <option value="FANTASY">íŒíƒ€ì§€</option>
            </select>
            <select class="form-control" style="width: auto;" id="status-filter">
                <option value="">ëª¨ë“  ìƒíƒœ</option>
                <option value="WRITING">ì—°ì¬ì¤‘</option>
                <option value="COMPLETED">ì™„ê²°</option>
            </select>
            <input type="text" class="form-control" placeholder="ì œëª©/ì‘ê°€ ê²€ìƒ‰..." style="flex: 1;" id="search-keyword">
        </div>

        <!-- Book Grid -->
        <div class="grid" id="book-list">
            <!-- JS will populate this -->
            <div class="card">
                <div
                    style="height: 150px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script>
            let searchTimeout = null;

            $(document).ready(function () {
                // Load categories for filter
                window.categoryMap = {}; // Global Map
                $.ajax({
                    url: '/api/categories',
                    method: 'GET',
                    success: function (response) {
                        const categories = response.data;
                        const $filter = $('#category-filter');
                        // Keep 'All' option
                        $filter.find('option:not(:first)').remove();
                        categories.forEach(cat => {
                            $filter.append(`<option value="${cat.categoryId}">${cat.categoryName}</option>`);
                            window.categoryMap[cat.categoryId] = cat.categoryName;
                        });
                    }
                });

                loadBooks();

                // Real-time search on input (with debouncing)
                $('#search-keyword').on('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function () {
                        loadBooks();
                    }, 500); // 500ms delay to avoid too many requests
                });

                // Auto-search on filter change
                $('#category-filter, #status-filter').on('change', function () {
                    loadBooks();
                });
            });

            function loadBooks() {
                const category = $('#category-filter').val();
                const status = $('#status-filter').val();
                const keyword = $('#search-keyword').val();

                // ì‹¤ì œ API í˜¸ì¶œ (íŒŒë¼ë¯¸í„° êµ¬ì„± í•„ìš”)
                $.ajax({
                    url: '/api/books',
                    method: 'GET',
                    data: { categoryId: category, status: status, keyword: keyword, page: 0, size: 20 },
                    success: function (response) {
                        const books = response.data.content; // Extract list from PageResponse
                        const $grid = $('#book-list');
                        $grid.empty();

                        if (books.length === 0) {
                            const emptyMsg = keyword ?
                                `"${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.` :
                                'ë“±ë¡ëœ ì†Œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.';
                            $grid.html(`
                                <div class="card" style="grid-column: 1/-1; padding: 60px 20px; text-align: center;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“š</div>
                                    <h3 style="color: var(--text-muted); margin-bottom: 10px;">${emptyMsg}</h3>
                                    <p style="color: var(--text-muted); font-size: 0.9rem;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                                </div>
                            `);
                            return;
                        }

                        books.forEach(book => {
                            const statusClass = book.status === 'WRITING' ? 'badge-writing' : 'badge-completed';
                            // Determine icon based on categoryId (Robust)
                            let icon = 'ğŸ“–';
                            const catId = book.categoryId;
                            if (catId === 'ROMANCE') icon = 'ğŸ’–';
                            else if (catId === 'THRILLER') icon = 'ğŸ”ª';
                            else if (catId === 'FANTASY') icon = 'ğŸ°';
                            else if (catId === 'SF') icon = 'ğŸ‘½';
                            else if (catId === 'MYSTERY') icon = 'ğŸ•µï¸';
                            else if (catId === 'DAILY') icon = 'â˜•';

                            const displayCategoryName = window.categoryMap && window.categoryMap[catId] ? window.categoryMap[catId] : catId;
                            const displayWriter = book.writerNicknm || 'ì‘ê°€ë‹˜';

                            const html = `
                        <div class="card" onclick="location.href='/books/${book.bookId}'" style="cursor: pointer;">
                            <div class="book-cover-placeholder">
                                <span class="book-icon">${icon}</span>
                            </div>
                            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <span class="badge ${statusClass}">${book.status}</span>
                                <span style="font-size: 0.8rem; color: var(--text-muted); text-transform:uppercase; letter-spacing:1px;">${displayCategoryName}</span>
                            </div>
                            <h3 style="margin-bottom: 10px; font-size: 1.4rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${book.title}</h3>
                            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px;">
                                <span style="color: var(--primary-color);">Make by.</span> ${displayWriter}
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                                <span style="font-size: 0.85rem; color: var(--text-muted);">
                                    ğŸ‘¥ ${book.participantCount || 1}ëª… ì°¸ì—¬
                                </span>
                                <span style="font-size: 0.85rem; color: var(--text-muted);">
                                    ğŸ“ ${book.currentSequence} ë¬¸ì¥
                                </span>
                            </div>
                        </div>
                    `;
                            $grid.append(html);
                        });
                    },
                    error: function () {
                        // API ì„œë²„ê°€ ì•„ì§ ì¤€ë¹„ ì•ˆë˜ì—ˆê±°ë‚˜ ì—°ê²° ì‹¤íŒ¨ ì‹œ ë”ë¯¸ ë°ì´í„° í‘œì‹œ (ë°ëª¨ìš©)
                        // alert('ì†Œì„¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        </script>
    </th:block>

</body>

</html>